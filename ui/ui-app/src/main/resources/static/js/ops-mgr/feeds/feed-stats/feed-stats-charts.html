<!--
  #%L
  thinkbig-ui-operations-manager
  %%
  Copyright (C) 2017 ThinkBig Analytics
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
<div class="feed-stats">
  <div fxLayout="column" *ngIf="dataLoaded" layout-padding>


    <mat-card style="padding : 8px;" fxLayoutAlign="center center">
      <mat-card-content fxLayout="column" style="width:100%;">
        <div fxLayout="row" class="">
          <div flex="100" fxLayout="column">
            <div fxLayout="column">
              <div fxLayout="row" fxLayoutAlign="space-between start" layout-fill>
                <span class="card-title right-card-title-text">{{timeFrameOptions[timeFrameOptionIndex].label}}</span>
                <span style="margin-top: 5px;">{{"OPS_MGR.FEEDS.FEEDS_STATS_CHARTS.DATE_RANGE"| translate}} {{minDisplayTime | date: 'MM/dd/yy HH:mm'}} - {{maxDisplayTime | date: 'MM/dd/yy HH:mm'}}</span>
              </div>
            </div>
            <div flex>
              <div class="md-slider-container" >
                <span class="hint">{{timeFrameOptions[0].label}}</span>
                <mat-slider (change)="onTimeFrameChanged()" flex [(ngModel)]="timeFrameOptionIndex" [min]="0" [max]="timeFrameOptionIndexLength - 1"></mat-slider>
                <span class="hint">{{timeFrameOptions[timeFrameOptionIndexLength - 1].label}}</span>
              </div>
            </div>
            <label *ngIf="isZoomed" class="hint">{{"OPS_MGR.FEEDS.FEEDS_STATS_CHARTS.ZOOM_LEVEL_REFRESH"| translate}} '{{timeFrameOptions[timeFrameOptionIndex].label}}'</label>
          </div>
          <span flex style="padding-left: 40px"></span>
          <div fxLayout="column">
            <div fxLayout="row">
              <div class="md-media-sm card-media layout-padding-left-right" style="cursor: pointer;" *ngIf="!autoRefresh" (click)="onRefreshButtonClick()">
                <button mat-button>{{"OPS_MGR.FEEDS.FEEDS_STATS_CHARTS.REFRESH" | translate}}</button>
              </div>
            </div>
            <mat-slide-toggle [color]="primary" (change)="completeAutoRefreshChange()" [aria-label]="'Auto Refresh'" [(ngModel)]="autoRefresh" >
              {{"OPS_MGR.FEEDS.FEEDS_STATS_CHARTS.AUTO_REFRESH" | translate}}
            </mat-slide-toggle>
          </div>
        </div>

      </mat-card-content>
    </mat-card>

    <div *ngIf="feedProcessorErrors.visibleData.length >0">
      <mat-card>
        <mat-toolbar class="md-table-toolbar md-default" fxLayout="column">
          <div class="md-toolbar-tools">
            <span> {{"views.feed-stats-charts.EM" | translate}} </span>
            <span flex="5"></span>
            <div flex style="margin-top:25px">
              <mat-form-field>
                <mat-input-container flex layout-fill>
                    <label> {{"views.feed-stats-charts.Filter" | translate}} </label>
                    <input [(ngModel)]="feedProcessorErrorsTable.filter" [ngModelOptions]="{debounce:1000}"/>
                </mat-input-container>
              </mat-form-field>
            </div>
            <span flex="5"></span>
            <div fxLayout="column" fxLayoutAlign="end end">
              <div fxLayout="row">
                <mat-slide-toggle class="md-primary" md-no-ink [aria-label]="'Auto Refresh'" [(ngModel)]="feedProcessorErrors.autoRefresh"
                           (change)="toggleFeedProcessorErrorsRefresh(feedProcessorErrors.autoRefresh)">
                  {{"OPS_MGR.FEEDS.FEEDS_STATS_CHARTS.AUTO_REFRESH" | translate}}: {{feedProcessorErrors.autoRefreshMessage}}
                </mat-slide-toggle>
                <button mat-button class="md-icon-button" *ngIf="feedProcessorErrors.autoRefresh == false" (click)="viewNewFeedProcessorErrors()">
                  <mat-icon>refresh</mat-icon>
                </button>
              </div>
              <span *ngIf="feedProcessorErrors.newErrorCount >0" class="hint" style="padding-bottom: 10px;margin-top:-10px;"> {{feedProcessorErrors.newErrorCount}} new errors exist.</span>
            </div>
          </div>
        </mat-toolbar>

        <md-table-container *ngIf="feedProcessorErrors.visibleData.length >0">
          <table md-table>
            <thead md-head md-order="feedProcessorErrorsTable.sortOrder">
            <tr md-row>
              <th md-column name="Processor" md-order-by="processorName"><span>{{"views.feed-stats-charts.Processor" | translate}}</span></th>
              <th md-column name="Errors" md-order-by="errorMessages"><span>{{"views.feed-stats-charts.Errors" | translate}}</span></th>
              <th md-column name="Time" md-order-by="errorMessageTimestamp" md-desc><span>{{"views.feed-stats-charts.Time" | translate}}</span></th>
            </tr>
            </thead>
            <tbody md-body>
            <tr md-row
                ng-repeat="item in feedProcessorErrors.visibleData | filter: feedProcessorErrorsTable.filter | orderBy:  feedProcessorErrorsTable.sortOrder | limitTo: feedProcessorErrorsTable.rowLimit : (feedProcessorErrorsTable.page -1) * feedProcessorErrorsTable.rowLimit">
              <td md-cell>{{item.processorName}}</td>
              <td md-cell>{{item.errorMessages}}</td>
              <td md-cell>{{item.errorMessageTimestamp | date:'HH:mm:ss'}}</td>
            </tr>
            </tbody>
          </table>
        </md-table-container>
        <md-table-pagination md-limit="feedProcessorErrorsTable.rowLimit" md-limit-options="[5,10,15,20,50,100]" md-page="feedProcessorErrorsTable.page"
                             md-total="{{feedProcessorErrors.visibleData.length}}" md-page-select="true" md-boundary-links="false"></md-table-pagination>
      </mat-card>

    </div>


    <div fxLayout="row" layout-sm="column" layout-xs="column">
      <div fxLayout="column" flex-gt-sm="70" flex-order="1" flex-order-xs="2" flex-order-sm="2">
        <!-- THE KPIs -->
        <div fxLayout="row" fxLayout.xs="column" layout-wrap fxLayoutAlign="space-between center" class="kpi-row">

          <div flex-gt-md="33" flex-gt-xs="50" class="service-wrapper kpi" layout-wrap>
            <mat-card style="padding : 8px;"fxLayoutAlign="center center" fxLayout="column" class="kpi">
              <mat-card-title fxLayout="column" fxLayoutAlign="center center" style="width:100%;">
                <span class="md-display-1">{{eventSuccessKpi.value}}% </span>
                <div class="md-media-sm card-media">
                  <mat-icon [ngStyle]="{'fill':eventSuccessKpi.color}" size="50">
                      eventSuccessKpi.icon
                  </mat-icon>
                </div>
              </mat-card-title>
              <mat-card-content fxLayout="column" fxLayoutAlign="center center">
                <span class="mat-title"> {{"views.feed-stats-charts.SR" | translate}} </span>
              </mat-card-content>
            </mat-card>
          </div>

          <div flex-gt-md="33" flex-gt-xs="50" class="kpi" layout-wrap>
            <mat-card style="padding : 8px;"fxLayoutAlign="center center" fxLayout="column">
              <mat-card-title fxLayout="column" fxLayoutAlign="center center" style="width:100%;">
                <span class="md-display-1">{{flowRateKpi.value}}/{{"views.feed-stats-charts.sec" | translate}}</span>
                <div class="md-media-sm card-media">
                  <mat-icon [ngStyle]="{'fill':flowRateKpi.color}" size="50">
                      flowRateKpi.icon
                  </mat-icon>
                </div>
              </mat-card-title>
              <mat-card-content fxLayout="column" fxLayourAlign="center center">
                <span class="mat-title">{{"views.feed-stats-charts.IFR" | translate}}</span>
              </mat-card-content>
            </mat-card>
          </div>

          <div flex-gt-md="33" flex-gt-xs="50" class="kpi" layout-wrap>
            <mat-card style="padding : 8px;"fxLayoutAlign="center center" fxLayout="column">
              <mat-card-title fxLayout="column" fxLayoutAlign="center center" style="width:100%;">
                <span class="md-display-1">{{avgDurationKpi.value}}</span>
                <div class="md-media-sm card-media">
                  <mat-icon [ngStyle]="{'fill':avgDurationKpi.color}" size="50">
                      avgDurationKpi.icon
                  </mat-icon>
                </div>
              </mat-card-title>
              <mat-card-content fxLayout="column" fxLayoutAlign="center center">
                <span class="mat-title">{{"views.feed-stats-charts.FD" | translate}}</span>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
        <!-- END KPIs -->

        <div>
          <mat-card style="padding : 8px;"fxLayoutAlign="start start" style="margin: 0">
            <mat-card-content flex="100" style="width: 100%; padding: 0">
              <div flex fxLayout="row" fxLayoutAlign="start end">
                <span flex *ngIf="feedTimeChartLoading">
                  <mat-progress-bar [disabled]="false" [mode]="indeterminate"></mat-progress-bar>
                </span>
                <span flex *ngIf="!feedTimeChartLoading">
                  <mat-progress-bar [disabled]="true" [mode]="indeterminate"></mat-progress-bar>
                </span>
              </div>
              <div fxLayout="row" fxLayoutAlign="space-between center">
                <div flex fxLayout="column">
                  <span class="card-title kpi-header layout-padding-left">{{"views.feed-stats-charts.AFR" | translate}}</span>
                  <span class="md-caption kpi-subtitle layout-padding-top layout-padding-left" [hidden]="!zoomEnabled">Zoom in/out and pan left/right to see custom time frame</span>
                </div>
                  <button mat-button (click)="onResetZoom()" [hidden]="!zoomEnabled">Reset Zoom</button>
              </div>

              <nvd3 [options]="feedChartOptions" [data]="feedChartData"></nvd3>

            </mat-card-content>
          </mat-card>
        </div>


        <div>
          <mat-card style="padding : 8px;"fxLayoutAlign="center center" style="margin-left: 0px;margin-right: 0px;">
            <mat-card-content layout-fill>

              <div fxLayout="column" fxLayoutAlign="start start">
                <span class="card-title kpi-header">{{"views.feed-stats-charts.FPM" | translate}}</span>
              </div>

              <mat-input-container class="md-block layout-padding-top-bottom">
                <label class="md-container-ignore label-small layout-padding-top">{{"views.feed-stats-charts.PM" | translate}}</label>
                <mat-select [(ngModel)]="selectedProcessorStatisticFunction" (change)="onProcessorChartFunctionChanged()" aria-label="Rule Type">
                  <mat-option [value]="opt" *ngFor="let opt of processorStatsFunctions">{{ 'views.feed-stats-charts.' + opt | translate}}</mat-option>
                </mat-select>
              </mat-input-container>

              <nvd3 flex [options]="processorChartOptions" [data]="processorChartData" config="{deepWatchOptions:true}"></nvd3>

            </mat-card-content>
          </mat-card>
        </div>


      </div>

      <div flex-gt-sm="30" flex-order="2" flex-order-xs="1" flex-order-sm="1" class="layout-padding-left" style="margin-top:-5px;">
        <mat-card style="padding : 8px;"class="right-card" >
          <mat-card-title>
            <div fxLayout="column">
              <div class="card-title right-card-title-text">{{"views.feed-stats-charts.FeedD" | translate}}</div>
            </div>
            <div fxLayout="column">
              <span class="item-title" class="layout-padding-top-bottom">{{feedName}}</span>
            </div>
          </mat-card-title>
          <mat-card-content>
            <div>
              <mat-divider></mat-divider>
              <mat-list layout-fill fxLayout="column" class="list-item-table">

                <mat-list-item style="padding: 16px;">
                  <div fxLayout="column" class="item-column mat-list-item-text ">
                        <span class="item-title" [ngClass]="{'healthy':feed.displayStatus == 'COMPLETED' || feed.displayStatus =='RUNNING'}">
                         {{feed.displayStatus}}</span>
                    <span class="column-title column-title-bottom">{{"views.common.status" | translate}}</span>
                  </div>
                  <mat-divider></mat-divider>
                </mat-list-item>

                <mat-list-item style="padding: 16px;">
                  <div>  
                    <span fxLayout="column" class="item-column mat-list-item-text ">
                        {{minDisplayTime | date: 'MM/dd/yy HH:mm'}} - {{maxDisplayTime | date: 'MM/dd/yy HH:mm'}}</span>
                    <span class="column-title column-title-bottom">Date Range</span>
                  </div>
                  <mat-divider></mat-divider>
                </mat-list-item>




                <mat-list-item style="padding: 16px;">
                  <div fxLayout="column" class="item-column mat-list-item-text ">
                    <span class="item-title">{{summaryStatistics.flowsStarted | number}}</span>
                    <span class="column-title column-title-bottom">{{"views.feed-stats-charts.FS" | translate}}</span>
                  </div>
                  <mat-divider></mat-divider>
                </mat-list-item>

                <mat-list-item style="padding: 16px;">
                  <div fxLayout="column" class="item-column mat-list-item-text ">
                    <span class="item-title">{{summaryStatistics.flowsFinished | number}}</span>
                    <span class="column-title column-title-bottom">{{"views.feed-stats-charts.FF" | translate}}</span>
                  </div>
                  <mat-divider></mat-divider>
                </mat-list-item>

                <mat-list-item style="padding: 16px;">
                  <div fxLayout="column" class="item-column mat-list-item-text ">
                    <span class="item-title">{{summaryStatistics.flowsRunning | number}}</span>
                    <span class="column-title column-title-bottom">{{"views.feed-stats-charts.FlowsR" | translate}}</span>
                  </div>
                  <mat-divider></mat-divider>
                </mat-list-item>

                <mat-list-item style="padding: 16px;">
                  <div fxLayout="column" class="item-column mat-list-item-text ">
                    <span class="item-title">{{summaryStatistics.flowsStartedPerSecond | number}} / {{"views.feed-stats-charts.sec" | translate}}</span>
                    <span class="column-title column-title-bottom">{{"views.feed-stats-charts.FlowsRate" | translate}}</span>
                  </div>
                  <mat-divider></mat-divider>
                </mat-list-item>

                <mat-list-item style="padding: 16px;">
                  <div fxLayout="column" class="item-column mat-list-item-text ">
                    <span class="item-title">{{avgDurationKpi.value}}</span>
                    <span class="column-title column-title-bottom">{{"views.feed-stats-charts.FD2" | translate}}</span>
                  </div>
                  <mat-divider></mat-divider>
                </mat-list-item>

                <mat-list-item style="padding: 16px;">
                  <div fxLayout="column" class="item-column mat-list-item-text ">
                    <span class="item-title">{{eventSuccessKpi.value }}%</span>
                    <span class="column-title column-title-bottom">{{"views.feed-stats-charts.SE" | translate}}</span>
                  </div>
                  <mat-divider></mat-divider>
                </mat-list-item>

                <mat-list-item style="padding: 16px;">
                  <div fxLayout="column" class="layout-padding-top-bottom layout-padding-left-right" fxLayoutAlign="space-between start">
                    <div class="md-subhead layout-padding-bottom">{{"view.main.links"| translate}}</div>
                    <div class="layout-padding-left ">
                       <button mat-button color="primary" (click)="gotoFeedDetails($event)">{{"views.feed-stats-charts.FeedD" | translate}}</button>
                    </div>
                  </div>
                </mat-list-item>


              </mat-list>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

    </div>


  </div>
  <div *ngIf="!dataLoaded" class="kpi-loading" fxLayoutAlign="center center" fxLayout="column">
    <mat-spinner mode="indeterminate" diameter="60"></mat-spinner>
  </div>
</div>
