<!--
  #%L
  thinkbig-ui-operations-manager
  %%
  Copyright (C) 2017 ThinkBig Analytics
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
<div flex layout="row">
  <mat-card flex="70">
    <mat-card-title flex layout>
      <div style="white-space:nowrap" class="card-title" flex>{{cardTitle}}</div>
    </mat-card-title>
    <mat-card-content>
      <ng-container *ngIf="unableToFindJob == false">
        <div layout="column" class="layout-padding">
          <div layout="row">

            <div flex="40" layout="column">
                   <span class="item-title">
                    {{jobData.name}}
                   </span>
                  <span class="column-title-bottom {{jobData.cssStatusClass}}">
                    <ng-md-icon *ngIf="jobData.statusIcon" class="{{jobData.tabIconStyle}}" icon="{{jobData.statusIcon}}" size="20">
                    </ng-md-icon>{{jobData.displayStatus | translate}}
                  </span>

            </div>

            <div flex="30" layout="column">
              <span class="item-title">{{jobData.startTime | date:'MMM d, yyyy HH:mm:ss'}}
              </span>
              <span class="column-title column-title-bottom">{{"views.job-details-template.ST" | translate}}</span>
            </div>
            <div flex="30" layout="column">
              <span class="item-title">
                  <div kylo-timer *ngIf="jobData.running" [startTime]="jobData.runTime"></div>
                  <span *ngIf="jobData.running == false">{{jobData.runTime | date: 'fullTime' }}</span>
              </span>
              <span class="column-title column-title-bottom">{{"views.job-details-template.RT" | translate}}</span>
            </div>
          </div>

          <div *ngIf="!vm.jobData.running" class="item-title">{{'views.job-details-template.ED' | translate}}</div>
          <div *ngIf="!vm.jobData.running" class="accent-color-3" style="white-space:pre-wrap;">
            {{jobData.exitDescription | truncate: 150}}
          </div>
        </div>
        <mat-tab-group [selectedIndex]="tabMetadata.selectedIndex" class="job-details-tabs" flex
                 layout-fill dynamicHeight>

          <mat-tab flex>
              <ng-template mat-tab-label>
                <span class="column-title-bottom {{jobData.cssStatusClass}}">
                    <!--<ng-md-icon *ngIf="jobData.statusIcon" class="{{jobData.tabIconStyle}}" icon="{{jobData.statusIcon}}" size="20">
                    </ng-md-icon>
                    -->{{'views.job-details-template.JD' | translate}}
                  </span>
              </ng-template>
            <div>
              <mat-divider></mat-divider>
              <div flex layout="column" class="tab-content">

                <div layout="row" layout-align="end center" style="padding: 8px 25px;">
                  <span class="md-button-group" layout="row" layout-align="end center">
                    <span flex></span>
                      <button class="border-btn md-button md-kylo-theme md-ink-ripple" style="max-width:200px;" [ngClass]="{'selected': showJobParameters == true}" (click)="toggleJobParameters('JobParameters')">
                          {{'views.job-details-template.JP' | translate}}
                      </button>
                      <button class="border-btn md-button md-kylo-theme md-ink-ripple" style="max-width:200px;" [ngClass]="{'selected': showJobParameters == false}" (click)="toggleJobParameters('ExecutionContext')">
                        {{'views.job-details-template.ECD' | translate}}
                      </button>
                  </span>

                </div>

                <mat-list *ngIf="pageState.loading == false" class="list-item-table">
                  <mat-divider></mat-divider>
                  <mat-list-item *ngIf="showJobParameters == true">
                    <div flex="30" class="item-column md-list-item-text grey">
                        {{'views.job-details-template.Parameters' | translate}}
                    </div>
                    <div flex="70" class="item-column md-list-item-text grey">
                        {{'views.job-details-template.Values' | translate}}
                    </div>
                    <mat-divider></mat-divider>
                  </mat-list-item>
                  <!--  | orderBy:'key' -->
                  <div *ngIf="showJobParameters == true">
                    <mat-list-item *ngFor="let item of jobData.jobParametersArray; let last = last;">
                      <div flex="30" style="word-wrap:break-word;" class="item-column md-list-item-text ">
                        {{item.key}}
                      </div>
                      <div flex="70" class="item-column md-list-item-text " style="word-wrap: break-word;">
                        {{item.value}}
                      </div>
                      <mat-divider *ngIf="!last"></mat-divider>
                    </mat-list-item>
                  </div>
                  <mat-list-item *ngIf="showJobParameters == false">
                    <div flex="30" class="item-column md-list-item-text grey">
                        {{'views.job-details-template.CP' | translate}}
                    </div>
                    <div flex="70" class="item-column md-list-item-text grey">
                        {{'views.job-details-template.Values' | translate}}
                    </div>
                    <mat-divider></mat-divider>
                  </mat-list-item>
                  <!--  | orderBy:'key' -->
                  <div *ngIf="showJobParameters == false">
                    <mat-list-item *ngFor="let item of jobData.executionContextArray; let last = last;">
                      <div flex="30" style="word-wrap:break-word;" class="item-column md-list-item-text ">
                        {{item.key}}
                      </div>
                      <div flex="70" class="item-column md-list-item-text ">
                        {{item.value}}
                      </div>
                      <mat-divider *ngIf="!last"></mat-divider>
                    </mat-list-item>
                  </div>
                </mat-list>

                <mat-divider></mat-divider>


              </div>

            </div>
          </mat-tab>

          <mat-tab flex>
              <ng-template mat-tab-label>
                  <span class="column-title-bottom">{{'views.job-details-template.SD' | translate}}</span>
              </ng-template>
            <div>
              <mat-divider></mat-divider>
              <div flex layout="column" class="tab-content">
                  <mat-list>
                  <mat-list-item *ngFor="let step of allSteps" class="pad-sm pad-left">
                   <div layout="column" layout-fill>

                    <div layout="row" (click)="step.content.open == true ? step.content.open = false : step.content.open = true"
                         class="md-list-item-text hover-highlight-pointer layout-padding-top-bottom ">

                      <div flex="40" layout="column">
                   <span class="item-title">
                    <ng-md-icon icon="{{step.content.open == true ? 'keyboard_arrow_up' : 'keyboard_arrow_down'}}" size="20">
                    </ng-md-icon>   {{step.title}} - {{step.content.name}}
                   </span>
                  <span class="pad-left-md {{step.content.cssStatusClass}}">
                      <ng-md-icon *ngIf="step.content.statusIcon" class="{{step.content.tabIconStyle}}" icon="{{step.content.statusIcon}}" size="20">
                      </ng-md-icon>{{step.content.displayStatus | translate}}</span>

                      </div>

                      <div flex="30" layout="column">
                                               <span class="item-title">{{step.content.startTime | date:'MMM d, yyyy HH:mm:ss'}}
                                               </span>
                        <span class="column-title column-title-bottom">{{'views.job-details-template.ST' | translate}}</span>
                      </div>
                      <div flex="30" layout="column">
                        <div layout="row">
                          <div>
                            <span class="item-title">
                             <div kylo-timer *ngIf="step.content.running" [startTime]="step.content.runTime"></div>
                             <span *ngIf="step.content.running == false">{{step.content.runTime | date: 'fullTime' }}</span>
                            </span>
                              <span class="column-title column-title-bottom">{{'views.job-details-template.RT' | translate}}</span>
                          </div>
                          <div>
                            <button md-no-ink *ngIf="logUiEnabledVar && step.content.displayStatus =='FAILED'" class="border-btn action-btn md-warn" (click)="navigateToLogsForStep(step)">Search Logs</button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div *ngIf="step.content.open" class="fade-in-out layout-padding-left-16">


                      <div ng-if="step.content.displayStatus != 'COMPLETED'" class="item-title pad-left pad-top-sm pad-bottom-sm">{{'views.job-details-template.ED' | translate}}</div>
                      <div ng-if="step.content.displayStatus != 'COMPLETED'" class="grey pad-bottom  pad-left" ng-text-truncate="step.content.exitDescription"
                           ng-tt-chars-threshold="150">
                      </div>
                      <mat-list flex layout-fill *ngIf="pageState.loading == false" class="list-item-table">
                        <mat-divider></mat-divider>
                        <mat-list-item>
                          <div flex="30" class="item-column md-list-item-text grey">
                            {{'views.job-details-template.CP' | translate}}
                          </div>
                          <div flex="70" class="item-column md-list-item-text grey">
                            {{'views.job-details-template.Values' | translate}}
                          </div>
                          <mat-divider></mat-divider>
                        </mat-list-item>
                        <!--  | orderBy:'key' -->
                        <mat-list-item *ngFor="let item of step.content.executionContextArray">
                          <div flex="30" style="word-wrap:break-word;" class="item-column md-list-item-text ">
                            {{item.key}}
                          </div>
                          <div flex="70" class="item-column md-list-item-text ">
                            {{item.value}}
                          </div>
                          <mat-divider *ngIf="!$last"></mat-divider>
                        </mat-list-item>
                      </mat-list>

                    </div>
                    <mat-divider></mat-divider>
                   </div>
                  </mat-list-item>
                  </mat-list>
                </div>
              </div>
          </mat-tab>
        </mat-tab-group>


      </ng-container>
      <ng-container *ngIf="unableToFindJob == true" style="min-height:300px">
        <div layout="column" layout-align="center center" flex>
          <span class="md-subhead">
          {{'views.job-details-template.Utftj' | translate}}
          </span>
        </div>
      </ng-container>
    </mat-card-content>
  </mat-card>

  <mat-card flex="30" style="height: 100%;" header-css="job-details-header" body-css="job-details-right-body" *ngIf="unableToFindJob == false">
    <mat-card-title flex layout>
      <div style="white-space:nowrap" class="card-title">{{'views.job-details-template.JD' | translate}}</div>
      <span flex></span>
    </mat-card-title>
    <mat-card-content>
      <ng-container flex md-scroll-y>
        <div class="card-content">
          <button class="border-btn action-btn"
                     *ngIf="!jobData.stream && jobData.status  && jobData.status !='COMPLETED' && jobData.status !='FAILED' && allowAdmin"
                     (click)="failJob($event)">{{'views.job-details-template.FAIL' | translate}}
          </button>
          <button class="border-btn action-btn" *ngIf="!jobData.stream && jobData.status && jobData.status =='FAILED' && allowAdmin"
                     (click)="abandonJob($event)">{{'views.job-details-template.ABANDON' | translate}}
          </button>

          <button class="border-btn action-btn" *ngIf="!jobData.stream && jobData.status && jobData.status =='FAILED' && allowAdmin && jobData.renderTriggerRetry" (click)="triggerSavepointReleaseFailure()">Force Fail</button>

          <button  class="border-btn action-btn" *ngIf="!jobData.stream && !jobData.running && jobData.renderTriggerRetry && allowAdmin " (click)="triggerSavepointRetry()">Retry</button>

          <button md-no-ink [ngClass]="jobData.status =='FAILED' ? 'border-btn action-btn md-warn': 'border-btn action-btn' " *ngIf="logUiEnabledVar" (click)="navigateToLogs(jobData.startTime, jobData.endTime)" >
            Search Logs
          </button>
        </div>
        <div *ngIf="jobData.errorMessage != ''" class="error">
          {{jobData.errorMessage }}
        </div>

        <mat-list flex layout-fill layout="column" class="list-item-table">
          <mat-list-item>

            <div layout="column" class="item-column md-list-item-text ">
              <span class="item-title">
                {{jobData.name}}
              </span>
              <span class="column-title-bottom {{jobData.cssStatusClass}}">
                <ng-md-icon
                    icon="{{jobData.statusIcon}}"
                    class="{{jobData.tabIconStyle}}"
                    size="20">
                </ng-md-icon>{{jobData.displayStatus | translate}}
              </span>

            </div>
          </mat-list-item>
          <mat-divider></mat-divider>
          <mat-list-item>

            <div layout="column" class="item-column md-list-item-text ">
                <span class="item-title">{{jobData.jobType | translate}}
                </span>
              <span class="column-title column-title-bottom">{{'views.job-details-template.Type' | translate}}</span>
            </div>
          </mat-list-item>
          <mat-divider></mat-divider>
          <mat-list-item>
            <div layout="column" class="item-column md-list-item-text ">
              <span class="item-title">{{jobData.startTime | date:'MMM d, yyyy HH:mm:ss'}}
              </span>
              <span class="column-title column-title-bottom">{{'views.job-details-template.ST' | translate}}</span>
            </div>
          </mat-list-item>
          <mat-divider></mat-divider>
          <mat-list-item *ngIf="jobData.endTime != null && jobData.running == false">
            <div layout="column" class="item-column md-list-item-text ">
              <span class="item-title">{{jobData.endTime | date:'MMM d, yyyy HH:mm:ss'}}
              </span>
              <span class="column-title column-title-bottom">{{'views.job-details-template.ET' | translate}}</span>
            </div>
          </mat-list-item>
          <mat-divider></mat-divider>
          <mat-list-item>
            <div layout="column" class="item-column md-list-item-text ">
                <span class="item-title">
                    <div kylo-timer *ngIf="jobData.running" [startTime]="jobData.runTime"></div>
                    <span *ngIf="jobData.running == false">{{jobData.runTime | date: 'fullTime' }}</span>
                </span>
              <span class="column-title column-title-bottom">{{'views.job-details-template.RT' | translate}}</span>
            </div>
          </mat-list-item>
          <mat-divider></mat-divider>
          <mat-list-item>
            <div layout="column" class="item-column md-list-item-text ">
                <span class="item-title">{{jobData.exitCode | translate}}
                </span>
              <span class="column-title column-title-bottom">{{'views.job-details-template.EC' | translate}}</span>
            </div>
          </mat-list-item>
          <mat-divider></mat-divider>

        </mat-list>
      </ng-container>
    </mat-card-content>
  </mat-card>
</div>
