<!--
  #%L
  thinkbig-ui-feed-manager
  %%
  Copyright (C) 2017 ThinkBig Analytics
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->

<div *ngIf="editSla != null"  >
  <div layout="row" layout-align="start start">
    <div flex></div>
    <button (click)="viewSlaAssessments($event)"  class="md-primary" *ngIf="feed && mode != 'NEW'">{{"views.service-level-agreement-form.SA" | translate}}</button>
  </div>

  <form #slaForm="ngForm" (change)="onChange(slaForm)">
    <div class="layout-padding-left-right-16">
      <span class="md-subhead">Conditions</span>

      <div *ngFor="let rule of editSla.rules; let i = index; let last = last" layout="column" class="layout-padding">
        <div layout="row">
          <div class="layout-padding-right md-body-2">{{(i+1)}}.</div>
        
          <div layout="column" flex class="layout-padding-left md-body-2">
            <span>{{rule.name}}</span>
            <mat-hint>{{rule.description}}</mat-hint>
          </div>
          <div>
            <div>
              <button class="icon-btn md-icon-button auto-height md-button md-kylo-theme md-ink-ripple" (click)="onDeleteSlaMetric(i)" *ngIf="rule.editable">
                <ng-md-icon icon="delete" size="20" style="fill:grey;"></ng-md-icon>
              </button>
            </div>
          </div>
        </div>
        <thinkbig-policy-input-form class="layout-padding-top" [theForm]="slaForm" [rule]="rule" [mode]="mode" [feed]="feed" [onPropertyChange]="onPropertyChange"></thinkbig-policy-input-form>

        <mat-divider *ngIf="!last" style="position: relative;"></mat-divider>

      </div>

      <div *ngIf="addingSlaCondition == false" layout="row">
        <button class="md-primary md-button md-kylo-theme md-ink-ripple" (click)="addNewCondition()">Add Condition</button>
        <span flex></span>
      </div>

      <div *ngIf="addingSlaCondition" class="layout-padding-left-right" layout="row" flex>

        <mat-form-field class="md-block layout-padding-top-bottom">
          <mat-label class="md-container-ignore mat-label-small layout-padding-top condensed">{{"views.service-level-agreement-form.SNC" | translate}}</mat-label>
          <mat-select name="slaCondition" [ngModel]="ruleType" (ngModelChange)="onRuleTypeChange($event)" [ngModelOptions]="{trackBy: 'value.name'}" (change)="onAddConditionRuleTypeChange()" aria-mat-label="Rule Type">
            <mat-option [value]="opt" *ngFor="let opt of options">{{ opt.name }}</mat-option>
          </mat-select>
        </mat-form-field>
        <span flex></span>
        <button class="icon-btn md-icon-button auto-height" (click)="addingSlaCondition = false" *ngIf="editSla != null && editSla.rules.length >0">
          <ng-md-icon icon="delete" size="20" style="fill:grey;"></ng-md-icon>
        </button>
      </div>

      <div>
        <span class="md-subhead">{{"views.service-level-agreement-form.SLAA" | translate}}</span>

        <div *ngIf="editSla.actionConfigurations.length ==0" layout="column" class="layout-padding">
          <span>{{"views.service-level-agreement-form.ASLAvwgaA" | translate}}</span>
          <span *ngIf="showActionOptions">{{"views.service-level-agreement-form.AddAction" | translate}}</span>
        </div>

        <div *ngIf="editSla.actionErrors != null && editSla.actionErrors.length >0" layout="column" class="layout-padding-left-right">
          <div class="error md-title bold layout-padding-left" layout="row">
            <div class="layout-padding-left">
              <ng-md-icon icon="warning" size="20" class="error">WARNING</ng-md-icon>
            </div>
            <span>{{"views.service-level-agreement-form.Errors-found" | translate}}</span>
          </div>

          <div *ngFor="let error of editSla.actionErrors" layout="column" class="layout-padding-left">
            <span class="error">{{error}}</span>
          </div>
        </div>

        <div *ngFor="let rule of editSla.actionConfigurations" layout="column" class="layout-padding">

          <div layout="row" class="">
            <div class="layout-padding-right md-body-2">{{(i+1)}}.</div>

            <div layout="column" flex class="layout-padding-left md-body-2">
              <span>{{rule.name}}</span>
              <span class="hint">{{rule.description}}</span>
              <span *ngIf="rule.validConfiguration == false" class="error"><strong>{{"views.service-level-agreement-form.Warning" | translate}}</strong>  {{"views.service-level-agreement-form.Warning2" | translate}} {{rule.validationMessage}}</span>
            </div>
            <div>
              <div>
                <button class="icon-btn md-icon-button auto-height" (click)="onDeleteSlaAction(i)" *ngIf="rule.editable">
                  <ng-md-icon icon="delete" size="20" style="fill:grey;"></ng-md-icon>
                </button>
              </div>
            </div>
          </div>


          <thinkbig-policy-input-form [theForm]="slaForm" [rule]="rule" [allowdit]="allowEdit" [onPropertyChange]="onPropertyChange"></thinkbig-policy-input-form>
          <mat-divider *ngIf="!last" style="position: relative;"></mat-divider>
        </div>

        <div *ngIf="addingSlaAction" class="layout-padding-left-right" layout="row">
          <div>Test</div>
          <mat-form-field class="md-block layout-padding-top-bottom condensed">
            <!-- <mat-label class="md-container-ignore mat-label-small layout-padding-top">{{"views.service-level-agreement-form.SNA" | translate}}</mat-label> -->
            <mat-select name="slaAction" [(ngModel)]="slaAction" placeholder='{{"views.service-level-agreement-form.SNA" | translate}}' [ngModelOptions]="{trackBy: 'value.name'}" (change)="onAddSlaActionChange()" aria-mat-label="Rule Type">
              <mat-option [value]="opt" *ngFor="let opt of slaActionOptions">{{ opt.name }}</mat-option>
            </mat-select>
          </mat-form-field>
          <button class="icon-btn md-icon-button auto-height" (click)="addingSlaAction = false">
            <ng-md-icon icon="delete" size="20" style="fill:grey;"></ng-md-icon>
          </button>
        </div>

        <div *ngIf="addingSlaAction == false" flex layout="row">
          <button class="md-primary" (click)="addingSlaAction = true" *ngIf="showActionOptions" [disabled]="editSla.rules.length ==0">{{"views.service-level-agreement-form.AA" | translate}}</button>
          <span flex></span>
        </div>

      </div>

      <div layout="column" class="layout-padding-top">
        <span class="md-subhead">Description</span>
        <div class="layout-padding-top-bottom">

        </div>

        <div class="layout-padding">

          <mat-form-field style="display:block" class="md-block condensed" >
            <mat-label>Name</mat-label>
            <input matInput  #slaName="ngModel" name="slaName" type="text" [(ngModel)]="editSla.name" md-placeholder="SLA name" [disabled]="!allowEdit" (change)="onNameChange($event)"
                  required/>
            <mat-hint align="start">
              <span [hidden]="!slaName.errors?.required || slaName.pristine" class="tc-red-600">This field is required.</span>
            </mat-hint>
          </mat-form-field>

          <mat-form-field style="display:block" class="md-block condensed">
            <mat-label>Description</mat-label>
            <input matInput  #slaDescription="ngModel" name="slaDescription" type="text" [(ngModel)]="editSla.description" md-placeholder="SLA Description" [disabled]="!allowEdit" (change)="onDescriptionChange($event)"
                  required/>
            <mat-hint align="start">
              <span [hidden]="!slaDescription.errors?.required || slaDescription.pristine" class="tc-red-600">This field is required.</span>
            </mat-hint>
          </mat-form-field>

        </div>
      </div>

      <div class="layout-padding-top-bottom" flex layout="row">
        <button class="md-button md-kylo-theme md-ink-ripple" (click)="onDeleteSla($event)" *ngIf="editSla != null && editSlaIndex != null && allowEdit">{{"views.service-level-agreement-form.Delete" | translate}}</button>
        <span flex></span>
        <button  class="md-button md-kylo-theme md-ink-ripple" (click)="cancelEditSla()" *ngIf="editSla != null">{{"views.service-level-agreement-form.Cancel" | translate}}</button>
        <button class="md-primary md-raised md-button md-kylo-theme md-ink-ripple" (click)="saveSla()" *ngIf="editSla != null && allowEdit" [disabled]="editSla.rules.length == 0 || slaForm.form.invalid">{{"views.service-level-agreement-form.SSLA" | translate}}</button>
      </div>

    </div>

  </form>

</div>

