<!--
  #%L
  thinkbig-ui-feed-manager
  %%
  Copyright (C) 2017 ThinkBig Analytics
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
  <mat-card>

    <mat-card-title>
        <div layout="row" layout-align="space-between-center" flex>
            <div class="card-title" flex>{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.COMPLETE_AND_REGISTER' | translate}}</div>
            <h2 class="card-sub-header" [translate]="'FEEDMGR.TEMPLATES.STEPPER.SELECT.COUNTER'" [translateParams]="{before:5,after:5}"></h2>
        </div>
    </mat-card-title>

    <mat-card-content class="md-padding" style="overflow:hidden;">
        <ng-container [formGroup]="formGroup">
            <div layout="column">

                <mat-form-field class="md-block condensed">
                    <textarea matInput name="description" [(ngModel)]="model.description" [ngModelOptions]="{standalone: true}" placeholder="Description"></textarea>
                </mat-form-field>

                <div layout="column">
                    <div class="md-subhead left-aligned md-subheader md-kylo-theme">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.STREAMING_TEMP' | translate}}</div>

                    <div layout="row" layout-align="start start">
                        <mat-checkbox name="isStream" [(ngModel)]="model.isStream" [ngModelOptions]="{standalone: true}" aria-label="Streaming Template">
                            {{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.STREAMING_TEMP' | translate}}
                        </mat-checkbox>
                        <span>{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.CHK_MSG' | translate}}</span>
                    </div>
                </div>

                <div layout="column" *ngIf="!model.isStream">
                    <div class="md-subhead left-aligned">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.BATCH_TEMP' | translate}}</div>

                    <div layout="column">
                        <mat-form-field class="md-block" flex="100">
                            <mat-label>{{'FEEDMGR.TEMPLATES.STEPPER' | translate}}Job creation flow rate interval (millis) </mat-label>
                            <input matInput name="timeBetweenStartingBatchJobs" [(ngModel)]="model.timeBetweenStartingBatchJobs" [ngModelOptions]="{standalone: true}" type="number"  />
                            <div class="hint" [innerHTML]="'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.OPS_MGR_WARN' | translate">
                            </div>
                        </mat-form-field>

                    </div>
                </div>

                <div layout="column" *ngIf="model.reusableTemplate">
                    <div class="md-subhead left-aligned">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.REUSABLE_TEMPLATE' | translate}}</div>
                    <span>{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.TEMPLATE_TO_BE_REUSABLE' | translate}}
                    </span>
                </div>

                <div layout="column" *ngIf="!model.reusableTemplate && model.allowPreconditions">
                    <div class="md-subhead left-aligned">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.FEED_SCHED_OPTS' | translate}}</div>
                    <div layout="row" layout-align="start start">
                        <div><ng-md-icon icon="check" style="fill:green" size="20"></ng-md-icon></div>
                        <span>{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.FEED_TRIGGERABLE' | translate}}</span>
                    </div>
                </div>

                <div layout="column" *ngIf="model.needsReusableTemplate && loaded">
                    <div class="md-subhead left-aligned">{{'FEEDMGR.TEMPLATES.IMPORT.CONNECTION_OPTIONS' | translate}}</div>
                    <div layout="row" *ngFor="let connection of model.reusableTemplateConnections">
                        <div layout="column" flex="50">
                            <span [translate]="'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.CONNECTION_FROM'" [translateParams]="{entity:connection.feedOutputPortName}"></span>
                        </div>
                        <div layout="column" flex="50">
                            <mat-form-field class="md-block condensed">
                                <mat-select name="port-{{connection.feedOutputPortName}}" [(ngModel)]="connection.inputPortDisplayName" (change)="onReusableTemplateConnectionChange(connection)"
                                            formControlName="port-{{connection.feedOutputPortName}}" required>
                                    <mat-option *ngFor="let inputPort of inputPortList" value="{{inputPort.value}}">
                                        <span>{{inputPort.label}}</span> <span class="hint" *ngIf="inputPort.description"> ({{inputPort.description | truncate:50}})</span>
                                    </mat-option>
                                </mat-select>
                                <mat-error *ngIf="formGroup.controls['port-'+connection.feedOutputPortName] && formGroup.controls['port-'+connection.feedOutputPortName].errors?.required" >
                                    {{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.FIELD_REQUIRED' | translate}}
                                </mat-error>
                                <mat-error *ngIf="formGroup.controls['port-'+connection.feedOutputPortName] && formGroup.controls['port-'+connection.feedOutputPortName].errors?.invalidConnection" >
                                    {{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.INPUT_PORT_NA' | translate}}
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <div layout="column">
                    <div class="md-subhead left-aligned">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.DISPLAY_OPTIONS' | translate}}</div>
                    <div layout="column" class="layout-padding-top-bottom">
                        <span class="md-input-label" style="font-size: 11px;">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.ICON' | translate}} </span>
                        <div layout="row">
                            <ng-md-icon icon="{{model.icon.title}}" size="45" style="margin:inherit" [ngStyle]="{'fill':model.icon.color}"></ng-md-icon>
                            <button class="md-primary md-button md-kylo-theme" (click)="showIconPicker()" style="margin-left:35px;">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.CHANGE_ICON' | translate}}</button>
                        </div>
                    </div>
                </div>
            </div>

            <thinkbig-template-order [model]="templateOrder" [templateId]="model.id" [templateName]="model.templateName" [addAsNew]="true" [addSaveBtn]="false"></thinkbig-template-order>

            <div layout="row" layout-align="space-between start" layout-fill>
              <div flex="100" layout="column">
                <div class="md-subhead left-aligned">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.LINEAGE_DS' | translate}}</div>
                <span class="hint">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.SELECT_DS' | translate}}</span>

                    <div *ngIf="loadingFlowData" layout="column" layout-align="start center" class="layout-padding-top-bottom">
                    <mat-spinner mode="indeterminate" class="md-accent"></mat-spinner>
                    <span>{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.LOADING' | translate}}</span>
                </div>

                    <div layout="row" layout-fill layout-align="space-between center" *ngIf="!loadingFlowData" class="layout-padding-top-bottom">
                    <div layout="column">

                        <div *ngFor="let dsDef of processorDatasourceDefinitions" layout="column">

                            <div layout="row">
                                <mat-checkbox name="selectedDatasource" [(ngModel)]="dsDef.selectedDatasource" [ngModelOptions]="{standalone: true}"
                                             aria-label="Processor Datasource Definition">{{dsDef.processorName}} - {{dsDef.datasourceDefinition.datasourceType}} -
                                    {{dsDef.datasourceDefinition.connectionType}}
                                </mat-checkbox>
                            </div>

                        </div>

                        <div *ngIf="processorDatasourceDefinitions.length ==0" class="layout-padding-top-bottom">
                            {{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.NO_PROCESSOR_FOUND' | translate}}
                        </div>

                    </div>

                </div>

                </div>

            </div>

            <div layout="column" *ngIf="!remoteProcessGroupValidation.validatingPorts && !remoteProcessGroupValidation.valid">
                <div class="md-subhead left-aligned">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER_TEMPLATE.RPG_ISSUE' | translate}}</div>
                <div layout="row" class="layout-padding-top-bottom">
                        <span>
                          <ng-md-icon icon="error" size="20" style="fill:red"></ng-md-icon>
                        </span>
                    <span [innerHtml]="remoteProcessGroupValidation.invalidMessage"></span>
                </div>
            </div>

            <div layout="row" layout-align="space-between start" layout-fill>
            <div flex="100" layout="column">
                <md-subheader class="md-subhead left-aligned">Comment</md-subheader>
                <div layout="column">
                    <md-input-container class="md-block" flex="100">
                        <label>Give short description of changes made.</label>
                        <textarea name="changeComment" ng-model="vm.model.changeComment"></textarea>
                    </md-input-container>
                </div>
            </div>

        </div>

        </ng-container>

        <div style="float:right;">
            <!--<button class="md-button md-kylo-theme" mat-button matStepperPrevious (click)="stepper.previous()">{{'views.step-buttons.Previous-btn' | translate}}</button>-->
            <!--<button class="md-raised md-primary md-button md-kylo-theme" [disabled]="!formGroup.valid" mat-button (click)="registerTemplate()">{{'FEEDMGR.TEMPLATES.STEPPER.REGISTER' | translate}}</button>-->
        </div>

    </mat-card-content>
</mat-card>
