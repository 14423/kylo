<!--
  #%L
  thinkbig-ui-feed-manager
  %%
  Copyright (C) 2017 ThinkBig Analytics
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
  <div>

    <mat-card header-css="filter-header" class="centered">

      <mat-card-title>
        <div layout="row" layout-align="center start">
          <div class="card-title">{{'FEEDMGR.TEMPLATES.IMPORT.CARD_TITLE' | translate}}<span *ngIf="templateParam != null">: {{templateParam.templateName}}</span></div>
          <span flex></span>
          <ng-md-icon icon="file_upload" style="fill:#F08C38;padding-right:16px;" size="30"></ng-md-icon>
        </div>
      </mat-card-title>


      <mat-card-content>

        <div layout="column" class="md-padding">
          <span *ngIf="templateParam == null">
          <div>
            <div class="item-title">{{'FEEDMGR.TEMPLATES.IMPORT.ITEM_TITLE' | translate}}</div>
          </div>

          <div class="layout-padding-indent">
            <mat-list flex layout-fill class="list-item-table list-condensed">

              <mat-list-item>
                <div layout="row" layout-fill>
                  <div flex="20" class="md-list-item-text hint">
                    {{'views.import_feed.Type' | translate}}
                  </div>
                  <div flex="10" class="md-list-item-text hint">
                    {{'views.import_feed.File_type' | translate}}
                  </div>
                  <div flex="60" class="md-list-item-text hint">
                    {'views.common.description' | translate}}
                  </div>

                </div>
              </mat-list-item>


              <mat-list-item>
                <div layout="row" layout-fill>
                  <div flex="20" class="md-list-item-text ">
                    {{'FEEDMGR.TEMPLATES.IMPORT.NIFI_TEMPLATE' | translate}}
                  </div>
                  <div flex="10" class="md-list-item-text ">
                    XML
                  </div>
                  <div flex="60" class="md-list-item-text ">
                    {{'FEEDMGR.TEMPLATES.IMPORT.IMPORTS_NIFI_TEMPLATE' | translate}}
                  </div>
                </div>
              </mat-list-item>

              <mat-list-item>
                <div layout="row" layout-fill>
                  <div flex="20" class="md-list-item-text ">
                    {{'FEEDMGR.TEMPLATES.IMPORT.KYLO_TEMPLATES_BUNDLE' | translate}}
                  </div>
                  <div flex="10" class="md-list-item-text ">
                    {{'views.import_feed.ZIP' | translate}}
                  </div>
                  <div flex="60" class="md-list-item-text ">
                    {{'FEEDMGR.TEMPLATES.IMPORT.IMPORTS_KYLO_CONF_AND_NIFI_TEMPLATE' | translate}}
                  </div>
                </div>
              </mat-list-item>
            </mat-list>
          </div>
          </span>
          <div layout="column" style="padding-top:15px;"
               class="layout-padding-indent">

            <upload-file *ngIf="templateParam == null" [(uploadFileModel)]="templateFile" (uploadFileModelChange)="changeFileModel($event)"></upload-file>

            <div *ngIf="uploadType == 'zip'">
              <div *ngIf="templateDataImportOption.errorMessages != null && templateDataImportOption.errorMessages.length >0">
                <div *ngFor="let message of templateDataImportOption.errorMessages" layout="column">
                  <div><ng-md-icon icon="warning" size="20" class="warn"></ng-md-icon> <span>{{message}}</span></div>
                </div>
              </div>

              <div *ngIf="nifiTemplateImportOption.errorMessages != null && nifiTemplateImportOption.errorMessages.length >0">
                <div *ngFor="let message of nifiTemplateImportOption.errorMessages" layout="column">
                  <div><ng-md-icon icon="warning" size="20" class="warn"></ng-md-icon> <span>{{message}}</span></div>
                </div>
              </div>

              <div layout="row" >

              <div class="condensed-no-float md-block layout-padding-bottom" flex="50" >
                <mat-checkbox name="templateDataImportOption" [(ngModel)]="templateDataImportOption.overwrite" aria-label="Overwrite if exists">
                  {{'view.main.overwrite' | translate}}
                </mat-checkbox>
                <div class="hint">
                  {{'FEEDMGR.TEMPLATES.IMPORT.OVERWRITE_HINT' | translate}}
                </div>
              </div>

              <div class="condensed-no-float md-block layout-padding-bottom" flex="50" >
                <mat-checkbox name="templateDataImportOption" [(ngModel)]="reusableTemplateImportOption.shouldImport" aria-label="Import reusable template" >
                  {{'FEEDMGR.TEMPLATES.IMPORT.IMPORT_REUSABLE_TEMPLATE' | translate}}
                </mat-checkbox>

                <div class="hint">
                  {{'FEEDMGR.TEMPLATES.IMPORT.IMPORT_REUSABLE_TEMPLATE_HINT' | translate}}
                </div>
              </div>

              </div>

              <div *ngIf="templateDataImportOption.properties && templateDataImportOption.properties.length >0 " flex layout="column">
                <div class="layout-padding-bottom">{{'FEEDMGR.TEMPLATES.IMPORT.NEEDFUL_PROPERTIES' | translate}}</div>

                <div *ngFor="let prop of templateDataImportOption.properties" layout="column" layout-align="start start">
                  <span>{{prop.processorName}}</span>
                  <div layout="row" flex layout-fill>
                    <mat-form-field>
                      <mat-label>{{prop.propertyKey}}</mat-label>
                      <input matInput name="propertyValue" type="text" [(ngModel)]="prop.propertyValue" autocomplete="new-password" name="{{prop.inputName}}">
                    </mat-form-field>
                  </div>
                </div>
              </div>

              <div *ngIf="(templateDataImportOption.overwrite)|| (reusableTemplateImportOption.errorMessages != null && reusableTemplateImportOption.errorMessages.length >0)">
                <div *ngFor="let message of reusableTemplateImportOption.errorMessages" layout="column">
                  <div><ng-md-icon icon="warning" size="20" class="warn"></ng-md-icon> <span>{{message}}</span></div>
                </div>

                <div *ngIf="reusableTemplateImportOption.properties && reusableTemplateImportOption.properties.length >0" flex layout="column">
                  <div class="layout-padding-bottom">{{'FEEDMGR.TEMPLATES.IMPORT.NEEDFUL_PROPERTIES' | translate}}</div>

                  <div *ngFor="let prop of reusableTemplateImportOption.properties" layout="column" layout-align="start start">
                    <span>{{prop.processorName}}</span>
                    <div layout="row" flex layout-fill>
                      <mat-form-field>
                        <mat-label>{{prop.propertyKey}}</mat-label>
                        <input matInput name="propertyValue" type="text" [(ngModel)]="prop.propertyValue" autocomplete="new-password" name="{{prop.inputName}}">
                      </mat-form-field>
                    </div>
                  </div>
                </div>


              </div>


            </div>

            <div *ngIf="uploadType == 'xml'"  layout-fill>
              <div *ngIf="nifiTemplateImportOption.errorMessages != null && nifiTemplateImportOption.errorMessages.length >0">
                <div *ngFor="let message of nifiTemplateImportOption.errorMessages" layout="column">
                  <div><ng-md-icon icon="warning" size="20" class="warn"></ng-md-icon> <span>{{message}}</span></div>
                </div>
              </div>

              <div *ngIf="reusableTemplateImportOption.properties && reusableTemplateImportOption.properties.length > 0" flex layout="column">
                <div class="layout-padding-bottom" [translate]="'FEEDMGR.TEMPLATES.IMPORT.NEEDFUL_PROPERTIES_WITH_COUNT' | translate" [translateParams]="{Length:reusableTemplateImportOption.properties.length}">
                </div>

                <div *ngFor="let prop of reusableTemplateImportOption.properties" layout="column" layout-align="start start">
                  <span>{{ prop.processorName }}</span>
                  <div layout="row" layout-fill>
                    <mat-form-field>
                      <label>{{ prop.propertyKey }}</label>
                      <input matInput name="propertyValue" type="text" [(ngModel)]="prop.propertyValue" autocomplete="new-password" name="{{prop.inputName}}">
                    </mat-form-field>
                  </div>
                </div>
              </div>

              <div layout="row">
              <div class="condensed-no-float md-block layout-padding-bottom" flex="50">
                <mat-checkbox name="nifiTemplateDataImportOption" [(ngModel)]="nifiTemplateImportOption.overwrite" aria-label="Overwrite if exists">
                  {{'view.main.overwrite' | translate}}
                </mat-checkbox>
                <div class="hint">
                  {{'FEEDMGR.TEMPLATES.IMPORT.REPLACE_HINT' | translate}}
                </div>
              </div>


              <div class="condensed-no-float md-block layout-padding-bottom" flex="50">
                <mat-checkbox name="reusableTemplateDataImportOption" [(ngModel)]="reusableTemplateImportOption.shouldImport" aria-label="Create a reusable flow (callable by other flows)">
                  {{'FEEDMGR.TEMPLATES.IMPORT.CREATE_REUSABLE_FLOW_TITLE' | translate}}
                </mat-checkbox>
                <div class="hint">
                  {{'FEEDMGR.TEMPLATES.IMPORT.CREATE_REUSABLE_FLOW' | translate}}
                </div>
              </div>

                <div class="condensed-no-float md-block layout-padding-bottom" flex="50" *ngIf="reusableTemplateImportOption.shouldImport && remoteProcessGroupAware">
                  <mat-checkbox name="remoteProcessGroupImportOption" [(ngModel)]="remoteProcessGroupImportOption.shouldImport" aria-label="Make available for Remote Process Groups">
                    {{'FEEDMGR.TEMPLATES.IMPORT.RPG_AWARE_TITLE' | translate}}
                  </mat-checkbox>
                  <div class="hint">
                    {{'FEEDMGR.TEMPLATES.IMPORT.RPG_AWARE_HINT' | translate}}
                  </div>
                </div>

              </div>

            </div>

          </div>

          <div layout="row" class="layout-padding-top">
            <button class="md-raised md-primary md-button md-kylo-theme md-ink-ripple" (click)="importTemplate()" *ngIf="(templateFile != null || templateParam != null) && !reusableTemplateInputPortsNeeded && !remoteProcessGroupInputPortsNeeded"
                       [disabled]="uploadInProgress">
                       {{'FEEDMGR.TEMPLATES.IMPORT.CARD_TITLE' | translate}}
            </button>
            <span flex="5"></span>
            <md-progress-linear flex md-mode="determinate" value="{{uploadProgress}}" *ngIf="uploadInProgress"></md-progress-linear>
          </div>

          <div layout="column">
            <div *ngFor="let msg of uploadStatusMessages" layout="row">
              <div flex>
                  <span *ngIf="msg.complete && msg.success ">
                    <ng-md-icon icon="check" size="20" style="fill:green" ></ng-md-icon>
                  </span>
                <span *ngIf="msg.complete && !msg.success">
                    <ng-md-icon icon="error" size="20" style="fill:red"></ng-md-icon>
                  </span>
                <span>{{msg.message}}</span>
              </div>
            </div>
          </div>



        </div>

        <div *ngIf="importResult != null" class="layout-padding-indent layout-padding-top-bottom">
          <div layout="row">
            <ng-md-icon icon="{{importResultIcon}}"
                        [ngStyle]="{'fill':importResultIconColor}"></ng-md-icon>
            <span style="padding-left:15px;">{{message}}</span>
            <span flex></span>
          </div>

          <mat-list class="padding-left" *ngFor="let errors of errorMap">
            <div class="md-warn" *ngIf="errors.length >0">Errors</div>
            <ng-template *ngFor="let error of errors; let last = last">
              <mat-list-item class="md-2-line">
                <div class="md-list-item-text">
                  <div *ngIf="error.processorName != null && error.processorName != '' "
                      style="color:grey">Processor: {{error.processorName}}
                  </div>
                  <div class="md-warn-text">{{error.message}}</div>
                </div>
                <mat-divider *ngIf="!last"></mat-divider>
              </mat-list-item>
            </ng-template>
          </mat-list>

          <div *ngIf="reusableTemplateInputPortsNeeded">

            <div layout="column">
            <ng-container [formGroup]="importTemplateForm" layout="column">
              <div class="md-subhead left-aligned">{{'FEEDMGR.TEMPLATES.IMPORT.CONNECTION_OPTIONS' | translate}}</div>
              <div layout="row" *ngFor="let connection of importResult.reusableTemplateConnections">
                <div layout="column" flex="50">
                  <span [translate]="'FEEDMGR.TEMPLATES.IMPORT.CONNECTION_FROM' | translate" [translateParams]="{outputPortName:connection.feedOutputPortName}"></span>
                </div>
                <div layout="column" flex="50">
                  <div class="md-block condensed">
                    <mat-select name="port-{{connection.feedOutputPortName}}" [(ngModel)]="connection.inputPortDisplayName" ng-change="onReusableTemplateConnectionChange(connection)"
                                formControlName="port-{{connection.feedOutputPortName}}" required>
                      <ng-template *ngFor="let inputPort of inputPortList">
                        <mat-option value="{{inputPort.value}}" [disabled]="inputPort.disabled">
                            <span>{{inputPort.label}}</span> <span class="hint" *ngIf="inputPort.description"> ({{inputPort.description | truncate:50}})</span>
                        </mat-option>
                      </ng-template>

                    </mat-select>
                    <mat-error *ngIf="importTemplateForm.controls['port-'+connection.feedOutputPortName] && importTemplateForm.controls['port-'+connection.feedOutputPortName].errors?.required" >
                      {{'FEEDMGR.TEMPLATES.IMPORT.FIELD_REQUIRED_ERROR' | translate}}
                    </mat-error>
                    <mat-error *ngIf="importTemplateForm.controls['port-'+connection.feedOutputPortName] && importTemplateForm.controls['port-'+connection.feedOutputPortName].errors?.invalidConnection" >
                      {{'FEEDMGR.TEMPLATES.IMPORT.INPUT_PORT_NOT_AVAILABLE_ERROR' | translate}}
                    </mat-error>
                  </div>
                </div>
              </div>
              <div layout="row" layout-align="start">
                <span flex="100"></span>
                <button (click)="cancelImport()">{{'view.main.cancel' | translate}}</button>
                <button class="md-primary" (click)="setReusableConnections()" *ngIf="!noReusableConnectionsFound">{{'views.import_feed.Import' | translate}}</button>
              </div>

                <div *ngIf="noReusableConnectionsFound" [innerHTML]="'FEEDMGR.TEMPLATES.IMPORT.NO_REUSABLE_TEMPLATE_FOUND_ERROR' | translate">
                  
                </div>
              </ng-container>
            </div>
          </div>

            <div *ngIf="remoteProcessGroupInputPortsNeeded && remoteProcessGroupImportOption.shouldImport">

              <mat-list class="padding-left" *ngIf="remoteProcessGroupImportOption.errorMessages.length >0">
                <div class="md-warn">{{'FEEDMGR.TEMPLATES.IMPORT.REMOTE_INPUT_PORT_ERROR' | translate}}</div>
                <ng-template *ngFor="let error of remoteProcessGroupImportOption.errorMessages; let last = last">
                  <mat-list-item class="md-2-line">
                    <div class="md-list-item-text">
                      <div class="md-warn-text">{{error}}</div>
                    </div>
                    <mat-divider *ngIf="!last"></mat-divider>
                  </mat-list-item>
                </ng-template>
              </mat-list>

            <div layout="column">

              <form #importTemplateForm=ngForm name="importTemplateForm" layout="column">
                <div class="md-subhead left-aligned">{{'FEEDMGR.TEMPLATES.IMPORT.RPG_INPUT_PORTS' | translate}}</div>
                <div [innerHTML]="'FEEDMGR.TEMPLATES.IMPORT.RPG_INPUT_PORTS_MESSAGE' | translate" *ngIf="importResult.remoteProcessGroupInputPortNames.length ==0">
                </div>

                  <div>
                    <mat-label>{{'FEEDMGR.TEMPLATES.IMPORT.REMOTE_INPUT_PORT_TITLE' | translate}}</mat-label>
                    <mat-select name="importResult" multiple [(ngModel)]="importResult.remoteProcessGroupInputPortNames" [ngModelOptions]="{trackBy: '$value.inputPortName'}">
                      <ng-template *ngFor="let port of remoteProcessGroupInputPortNames">
                        <mat-option [value]="port" >
                          {{port.inputPortName}}
                        </mat-option>
                      </ng-template>
                    </mat-select>
                  </div>

                <div layout="row" layout-align="start">
                  <span flex="100"></span>
                  <button (click)="cancelImport()">{{'view.main.cancel' | translate}}</button>
                  <button class="md-primary" (click)="setRemoteProcessInputPorts()">{{'views.import_feed.Import' | translate}}</button>
                </div>


              </form>
            </div>
          </div>

          <div *ngIf="!xmlType && showReorderList">
            <thinkbig-template-order [templateId]="importResult.templateId" [templateName]="importResult.templateName" [addAsNew]="false" [addSaveBtn]="true"></thinkbig-template-order>
          </div>

        </div>
      </mat-card-content>
    </mat-card>
  </div>
