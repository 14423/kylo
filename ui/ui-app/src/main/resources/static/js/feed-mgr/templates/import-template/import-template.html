<!--
  #%L
  thinkbig-ui-feed-manager
  %%
  Copyright (C) 2017 ThinkBig Analytics
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
  <div>

    <mat-card header-css="filter-header" class="centered">
  
      <mat-card-title>
        <div layout="row" layout-align="center start">
          <div class="card-title">Import Template<span *ngIf="templateParam != null">: {{templateParam.templateName}}</span></div>
          <span flex></span>
          <ng-md-icon icon="file_upload" style="fill:#F08C38;padding-right:16px;" size="30"></ng-md-icon>
        </div>
      </mat-card-title>
  
  
      <mat-card-content>
  
        <div layout="column" class="md-padding">
          <span *ngIf="templateParam == null">
          <div>
            <div class="item-title">Import one of the following from another environment:</div>
          </div>
  
          <div class="layout-padding-indent">
            <mat-list flex layout-fill class="list-item-table list-condensed">
  
              <mat-list-item>
                <div layout="row" layout-fill>
                  <div flex="20" class="md-list-item-text hint">
                    Type
                  </div>
                  <div flex="10" class="md-list-item-text hint">
                    File type
                  </div>
                  <div flex="60" class="md-list-item-text hint">
                    Description
                  </div>
  
                </div>
              </mat-list-item>
  
  
              <mat-list-item>
                <div layout="row" layout-fill>
                  <div flex="20" class="md-list-item-text ">
                    NiFi template
                  </div>
                  <div flex="10" class="md-list-item-text ">
                    XML
                  </div>
                  <div flex="60" class="md-list-item-text ">
                    Imports a NiFi template
                  </div>
                </div>
              </mat-list-item>
  
              <mat-list-item>
                <div layout="row" layout-fill>
                  <div flex="20" class="md-list-item-text ">
                    Kylo template bundle
                  </div>
                  <div flex="10" class="md-list-item-text ">
                    ZIP
                  </div>
                  <div flex="60" class="md-list-item-text ">
                    Imports Kylo configuration and NiFi template
                  </div>
                </div>
              </mat-list-item>
            </mat-list>
          </div>
          </span>
          <div layout="column" style="padding-top:15px;"
               class="layout-padding-indent">
               
            <upload-file *ngIf="templateParam == null" [(uploadFileModel)]="templateFile" (uploadFileModelChange)="changeFileModel($event)"></upload-file>
  
            <div *ngIf="uploadType == 'zip'">
              <div *ngIf="templateDataImportOption.errorMessages != null && templateDataImportOption.errorMessages.length >0">
                <div *ngFor="let message of templateDataImportOption.errorMessages" layout="column">
                  <div><ng-md-icon icon="warning" size="20" class="warn"></ng-md-icon> <span>{{message}}</span></div>
                </div>
              </div>
  
              <div *ngIf="nifiTemplateImportOption.errorMessages != null && nifiTemplateImportOption.errorMessages.length >0">
                <div *ngFor="let message of nifiTemplateImportOption.errorMessages" layout="column">
                  <div><ng-md-icon icon="warning" size="20" class="warn"></ng-md-icon> <span>{{message}}</span></div>
                </div>
              </div>
  
              <div layout="row" >
  
              <div class="condensed-no-float md-block layout-padding-bottom" flex="50" >
                <mat-checkbox name="templateDataImportOption" [(ngModel)]="templateDataImportOption.overwrite" aria-label="Overwrite if exists">
                  Overwrite
                </mat-checkbox>
                <div class="hint">
                  If a feed template with the same name (as inside the .zip) already exists in NiFi, it will be replaced.
                </div>
              </div>
  
              <div class="condensed-no-float md-block layout-padding-bottom" flex="50" >
                <mat-checkbox name="templateDataImportOption" [(ngModel)]="reusableTemplateImportOption.overwrite" aria-label="Overwrite if exists" >
                  Import the reusable template
                </mat-checkbox>
  
                <div class="hint">
                  If the archive contains a reusable template it will be imported.  If a reusable template with the same name already exists in NiFi it will be replaced and re-initialized.
                </div>
              </div>
  
              </div>
  
              <div *ngIf="templateDataImportOption.properties && templateDataImportOption.properties.length >0 " flex layout="column">
                <div class="layout-padding-bottom">The following properties need to be supplied before importing this feed template</div>
  
                <div *ngFor="let prop of templateDataImportOption.properties" layout="column" layout-align="start start">
                  <span>{{prop.processorName}}</span>
                  <div layout="row" flex layout-fill>
                    <mat-form-field>
                      <mat-label>{{prop.propertyKey}}</mat-label>
                      <input matInput name="propertyValue" type="text" [(ngModel)]="prop.propertyValue" autocomplete="new-password" name="{{prop.inputName}}">
                    </mat-form-field>
                  </div>
                </div>
              </div>
  
              <div *ngIf="(templateDataImportOption.overwrite)|| (reusableTemplateImportOption.errorMessages != null && reusableTemplateImportOption.errorMessages.length >0)">
                <div *ngFor="let message of reusableTemplateImportOption.errorMessages" layout="column">
                  <div><ng-md-icon icon="warning" size="20" class="warn"></ng-md-icon> <span>{{message}}</span></div>
                </div>
  
                <div *ngIf="reusableTemplateImportOption.properties && reusableTemplateImportOption.properties.length >0" flex layout="column">
                  <div class="layout-padding-bottom">The following properties need to be supplied before importing this feed template</div>
  
                  <div *ngFor="let prop of reusableTemplateImportOption.properties" layout="column" layout-align="start start">
                    <span>{{prop.processorName}}</span>
                    <div layout="row" flex layout-fill>
                      <mat-form-field>
                        <mat-label>{{prop.propertyKey}}</mat-label>
                        <input matInput name="propertyValue" type="text" [(ngModel)]="prop.propertyValue" autocomplete="new-password" name="{{prop.inputName}}">
                      </mat-form-field>
                    </div>
                  </div>
                </div>
  
  
              </div>
  
  
            </div>
  
            <div *ngIf="uploadType == 'xml'"  layout-fill>
              <div *ngIf="nifiTemplateImportOption.errorMessages != null && nifiTemplateImportOption.errorMessages.length >0">
                <div *ngFor="let message of nifiTemplateImportOption.errorMessages" layout="column">
                  <div><ng-md-icon icon="warning" size="20" class="warn"></ng-md-icon> <span>{{message}}</span></div>
                </div>
              </div>
  
  
              <div layout="row">
              <div class="condensed-no-float md-block layout-padding-bottom" flex="50">
                <mat-checkbox name="nifiTemplateDataImportOption" [(ngModel)]="nifiTemplateImportOption.overwrite" aria-label="Overwrite if exists">
                  Overwrite
                </mat-checkbox>
                <div class="hint">
                  Replace any existing template in NiFi that has the same name.
                </div>
              </div>
  
  
              <div class="condensed-no-float md-block layout-padding-bottom" flex="50">
                <mat-checkbox name="reusableTemplateDataImportOption" [(ngModel)]="reusableTemplateImportOption.shouldImport" aria-label="Create a reusable flow (callable by other flows)">
                  Create Reusable Flow
                </mat-checkbox>
                <div class="hint">
                  Create a reusable flow from this template under 'reusable_templates' process group in NiFi. Other feed templates can reuse this template's flow by connecting to it.
                </div>
              </div>
  
                <div class="condensed-no-float md-block layout-padding-bottom" flex="50" *ngIf="reusableTemplateImportOption.shouldImport && remoteProcessGroupAware">
                  <mat-checkbox name="remoteProcessGroupImportOption" [(ngModel)]="remoteProcessGroupImportOption.shouldImport" aria-label="Make available for Remote Process Groups">
                   Remote Process Group Aware
                  </mat-checkbox>
                  <div class="hint">
                   Make this template available for Feed Remote Process Groups
                  </div>
                </div>
  
              </div>
  
            </div>
  
          </div>
  
          <div layout="row" class="layout-padding-top">
            <button class="md-raised md-primary md-button md-kylo-theme md-ink-ripple" (click)="importTemplate()" *ngIf="(templateFile != null || templateParam != null) && !reusableTemplateInputPortsNeeded && !remoteProcessGroupInputPortsNeeded"
                       [disabled]="uploadInProgress">
              Import Template
            </button>
            <span flex="5"></span>
            <md-progress-linear flex md-mode="determinate" value="{{uploadProgress}}" *ngIf="uploadInProgress"></md-progress-linear>
          </div>
  
          <div layout="column">
            <div *ngFor="let msg of uploadStatusMessages" layout="row">
              <div flex>
                  <span *ngIf="msg.complete && msg.success ">
                    <ng-md-icon icon="check" size="20" style="fill:green" ></ng-md-icon>
                  </span>
                <span *ngIf="msg.complete && !msg.success">
                    <ng-md-icon icon="error" size="20" style="fill:red"></ng-md-icon>
                  </span>
                <span>{{msg.message}}</span>
              </div>
            </div>
          </div>
  
  
  
        </div>
  
        <div *ngIf="importResult != null" class="layout-padding-indent layout-padding-top-bottom">
          <div layout="row">
            <ng-md-icon icon="{{importResultIcon}}"
                        [ngStyle]="{'fill':importResultIconColor}"></ng-md-icon>
            <span style="padding-left:15px;">{{message}}</span>
            <span flex></span>
          </div>
  
          <mat-list class="padding-left" *ngFor="let errors of errorMap">
            <div class="md-warn" *ngIf="errors.length >0">Errors</div>
            <ng-template *ngFor="let error of errors; let last = last">
              <mat-list-item class="md-2-line">
                <div class="md-list-item-text">
                  <div *ngIf="error.processorName != null && error.processorName != '' "
                      style="color:grey">Processor: {{error.processorName}}
                  </div>
                  <div class="md-warn-text">{{error.message}}</div>
                </div>
                <mat-divider *ngIf="!last"></mat-divider>
              </mat-list-item>
            </ng-template>
          </mat-list>
  
          <div *ngIf="reusableTemplateInputPortsNeeded">
  
            <div layout="column">
            <ng-container [formGroup]="importTemplateForm" layout="column">
              <div class="md-subhead left-aligned">Connection Options</div>
              <div layout="row" *ngFor="let connection of importResult.reusableTemplateConnections">
                <div layout="column" flex="50">
                  <span>Connect From: {{connection.feedOutputPortName}}</span>
                </div>
                <div layout="column" flex="50">
                  <div class="md-block condensed">
                    <mat-select name="port-{{connection.feedOutputPortName}}" [(ngModel)]="connection.inputPortDisplayName" ng-change="onReusableTemplateConnectionChange(connection)"
                                formControlName="port-{{connection.feedOutputPortName}}" required>
                      <ng-template *ngFor="let inputPort of inputPortList">
                        <mat-option value="{{inputPort.value}}" [disabled]="inputPort.disabled">
                            <span>{{inputPort.label}}</span> <span class="hint" *ngIf="inputPort.description"> ({{inputPort.description | truncate:50}})</span>
                        </mat-option>
                      </ng-template>
  
                    </mat-select>
                    <mat-error *ngIf="importTemplateForm.controls['port-'+connection.feedOutputPortName] && importTemplateForm.controls['port-'+connection.feedOutputPortName].errors?.required" >
                        This field is required.
                    </mat-error>
                    <mat-error *ngIf="importTemplateForm.controls['port-'+connection.feedOutputPortName] && importTemplateForm.controls['port-'+connection.feedOutputPortName].errors?.invalidConnection" >
                        The selected input port is no longer available.
                    </mat-error>
                  </div>
                </div>
              </div>
              <div layout="row" layout-align="start">
                <span flex="100"></span>
                <button (click)="cancelImport()">Cancel</button>
                <button class="md-primary" (click)="setReusableConnections()" *ngIf="!noReusableConnectionsFound">Import</button>
              </div>
  
                <div *ngIf="noReusableConnectionsFound">
                  ERROR!!!!! There are no other reusable connections found.
                  You will need to re import additional templates before registering this one.
                </div>
              </ng-container>
            </div>
          </div>
  
            <div *ngIf="remoteProcessGroupInputPortsNeeded && remoteProcessGroupImportOption.shouldImport">
  
              <mat-list class="padding-left" *ngIf="remoteProcessGroupImportOption.errorMessages.length >0">
                <div class="md-warn">Remote Input Port Errors</div>
                <ng-template *ngFor="let error of remoteProcessGroupImportOption.errorMessages; let last = last">
                  <mat-list-item class="md-2-line">
                    <div class="md-list-item-text">
                      <div class="md-warn-text">{{error}}</div>
                    </div>
                    <mat-divider *ngIf="!last"></mat-divider>
                  </mat-list-item>
                </ng-template>
              </mat-list>
  
            <div layout="column">
  
              <form #importTemplateForm=ngForm name="importTemplateForm" layout="column">
                <div class="md-subhead left-aligned">Remote Process Group Input Ports</div>
                <div *ngIf="importResult.remoteProcessGroupInputPortNames.length ==0">
                  Please select at least one input port to be available to remote process groups.
                  <br/>
                  If you dont wish to expose your template to remote process groups uncheck <i>Remote Process Group Aware</i> option above
                </div>
  
                  <div>
                    <mat-label>Remote Input Ports</mat-label>
                    <mat-select name="importResult" multiple [(ngModel)]="importResult.remoteProcessGroupInputPortNames" [ngModelOptions]="{trackBy: '$value.inputPortName'}">
                      <ng-template *ngFor="let port of remoteProcessGroupInputPortNames">  
                        <mat-option [value]="port" >
                          {{port.inputPortName}}
                        </mat-option>
                      </ng-template>
                    </mat-select>
                  </div>
  
                <div layout="row" layout-align="start">
                  <span flex="100"></span>
                  <button (click)="cancelImport()">Cancel</button>
                  <button class="md-primary" (click)="setRemoteProcessInputPorts()">Import</button>
                </div>
  
  
              </form>
            </div>
          </div>
  
          <div *ngIf="!xmlType && showReorderList">
            <thinkbig-template-order [templateId]="importResult.templateId" [templateName]="importResult.templateName" [addAsNew]="false" [addSaveBtn]="true"></thinkbig-template-order>
          </div>
  
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  