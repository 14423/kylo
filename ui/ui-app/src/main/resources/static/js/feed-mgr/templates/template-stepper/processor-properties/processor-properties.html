<!--
  #%L
  thinkbig-ui-feed-manager
  %%
  Copyright (C) 2017 ThinkBig Analytics
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
<ng-template #mentionCustomTemplate let-item="item">
        <div>
            <span [innerHtml]="item.key"></span>
            <span style="padding-left:15px;color:#cccccc" [innerHtml]="item.dataType"></span>
            <span style="padding-left:15px;" [innerHtml]="item.value"></span>
        </div>
        <mat-hint>
            {{item.description}}
        </mat-hint>
</ng-template>
<div layout="row" layout-align="center start" style="margin-top: 16px;">

    <mat-card class="not-centered layout-fill" style="max-width:980px;width:980px;overflow-x:inherit; margin-left: 16px;" flex="initial">

        <mat-card-title>
            <div layout="row" layout-align="space-between-center" flex>
                <div flex class="card-title"flex>{{cardTitle}}</div>
                <div class="card-sub-header" [translate]="'FEEDMGR.TEMPLATES.STEPPER.SELECT.COUNTER'" [translateParams]="{before : stepNumber, after: 5}"></div>
            </div>
        </mat-card-title>

        <mat-card-content style="padding:0; height:350px;overflow: auto; margin:0">

            <ng-container layout-fill>
                <div *ngFor="let property of allProperties" style="height: auto !important; min-height: auto;" layout="column" layout-fill>
                    <div *ngIf="property.firstProperty" layout="row" class="layout-padding-left-16 layout-padding-top-bottom" style="background-color:#F9F9F9;">
                        <a id="{{property.processor.id}}" name="{{property.processor.name}}"></a>
                        <span class="primary-color-1 md-subhead left-aligned">{{property.processor.name}}</span>
                    </div>
                    <div layout="row" style="padding-left:30px;">
                        <div style="height:30px;margin-bottom:5px;padding-top: 16px;">
                            <div class="mat-checkbox-div-top" *ngFor="let v of [0]">
                                <mat-checkbox name="selectedProperty" aria-label="Select" [ngModelOptions]="{standalone: true}" [(ngModel)]="property.selected"></mat-checkbox>
                            </div>
                        </div>
                        <div class="register-template-property md-padding" layout="column" layout-fill>
                            <h3 [ngClass]="{'md-warn':property.sensitive}">{{property.key}}</h3>

                                    <!--
                                    <mat-hint *ngIf="property.propertyDescriptor.sensitive">{{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.NIFI_SENSETIVE' | translate}}</mat-hint>
                                    <mat-hint *ngIf="property.propertyDescriptor.required">
                                        {{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.NIFI_REQUIRED' | translate}}
                                    </mat-hint>
                                    -->
                            <mat-hint>
                                {{property.propertyDescriptor.description}}
                            </mat-hint>

                            <div *ngIf="property.selected == true" class="fade">
                                <form [formGroup]="formGroup">

                                    <div *ngIf="property.propertyDescriptor.allowableValues != null" style="padding: 2px; margin: 18px 16px 18px 0;">
                                        <div md-no-float class="">
                                            <mat-label style="font-size: 12px; color: rgba(0,0,0,0.54);">{{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.DV' | translate}}</mat-label>
                                            <mat-select [(ngModel)]="property.value" name="property"
                                                        placeholder="Default Value"
                                                        [ngModelOptions]="{standalone: true}">
                                                <mat-option *ngFor="let allowableValue of property.propertyDescriptor.allowableValues"
                                                        value="{{allowableValue.value}}">
                                                    {{allowableValue.displayName }}
                                                </mat-option>
                                            </mat-select>
                                        </div>
                                    </div>


                                    <div style="display: flex; justify-content: space-between;" *ngIf="property.propertyDescriptor.allowableValues == null && property.selected == true" layout="row">

                                        <mat-form-field style="margin: 0; width: 100%;" class="push-top-md push-bottom-none">
                                            <mat-label style="font-size: 12px;">{{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.DVSE' | translate}}</mat-label>
                                            <input *ngIf="!property.userEditable && property.propertyDescriptor.required && viewInitialized"
                                                matInput
                                                name="propertyInput"
                                                placeholder="Enter a string or ${expression}" 
                                                type="text"
                                                [mentions]="expressionPropertiesMentions"
                                                (searchTerm)="searchExpressionProperties($event)"
                                                [(ngModel)]="property.value"
                                                size="100"
                                                formControlName="{{property.key}}"
                                                (change)="changedPropertyInput(property)"
                                                (keydown)="keydownPropertyInput(property)"
                                                required/>

                                            <input *ngIf="(property.userEditable || !property.propertyDescriptor.required) && viewInitialized"
                                                matInput
                                                name="propertyInput"
                                                placeholder="Enter a string or ${expression}" 
                                                type="text"
                                                [mentions]="expressionPropertiesMentions"
                                                (searchTerm)="searchExpressionProperties($event)"
                                                [(ngModel)]="property.value"
                                                size="100"
                                                (change)="changedPropertyInput(property)"
                                                (keydown)="keydownPropertyInput(property)"
                                                [ngModelOptions]="{standalone: true}"/>

                                        </mat-form-field>
                                <div class="hint" thinkbig-derived-expression [model]="property.value" style="margin-bottom:10px;"></div>

                                <div class="push-none push-left push-right" style="white-space: nowrap;" *ngIf="property.value == null || property.value == ''">
                                    <div class="md-checkbox-div-top" *ngFor="let v of [0]">
                                        <mat-checkbox aria-label="Set empty" [checked]="property.value == ''" (click)="toggleSetAsEmptyString(property)">
                                            Set empty
                                        </mat-checkbox>
                                    </div>
                                </div>

                                <div *ngIf="allowUserToAcceptPropertyValueFromNiFi(property)" layout="column" style="white-space: nowrap;">
                                    <div md-no-float>
                                        <div layout="row">
                                            <div style="color:#0288d1; background-color:#0288d126" class="layout-padding-left-4 layout-padding-right-4">
                                                <mat-icon class="tc-accent" size="20">info</mat-icon>{{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.NIFI_TEMPLATE_DV' | translate}} <b>{{ property.registrationChangeInfo.valueFromNewerNiFiTemplate }}</b>
                                            </div>
                                            <div class="layout-padding-left-4">
                                                <mat-icon matTooltip="'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.FROM_TO' | translate:property.registrationChangeInfo.valueFromNewerNiFiTemplate,property.value" color="tc-accent" (click)="acceptPropertyValueFromNiFi(property)" class="cursor-pointer md-ink-ripple">replay</mat-icon>
                                            </div>
                                            </div>
                                        </div>
                                        </div>

                                    </div>

                                    <div layout="row" layout-align="start-center" class="pull-bottom-sm" style="margin-bottom: 16px;">
                                        <div class="push-none push-right">
                                            <div class="mat-checkbox-div-top" *ngFor="let v of [0]">
                                                <mat-checkbox aria-label="User can supply input"
                                                                [(ngModel)]="property.userEditable"
                                                                name="userEditable"
                                                                [ngModelOptions]="{standalone: true}">
                                                                Allow user input
                                                </mat-checkbox>
                                            </div>
                                        </div>
                                        <div class="push-none push-right">
                                            <div class="mat-checkbox-div-top" *ngFor="let v of [0]">
                                                <mat-checkbox aria-label="User can supply input"
                                                                [(ngModel)]="property.sensitive"
                                                                name="sensitive"
                                                                [ngModelOptions]="{standalone: true}"
                                                                [disabled]="property.propertyDescriptor.sensitive">
                                                                Sensitive
                                                </mat-checkbox>
                                            </div>
                                        </div>
                                        <div class="push-none" *ngIf="property.userEditable">
                                            <div class="mat-checkbox-div-top" *ngFor="let v of [0]">
                                                <mat-checkbox aria-label="Required"
                                                            [(ngModel)]="property.required"
                                                            name="required"
                                                            [ngModelOptions]="{standalone: true}"
                                                            [disabled]="property.propertyDescriptor.required">
                                                Required
                                                </mat-checkbox>
                                            </div>
                                        </div>
                                    </div>
                                    <div fxLayout="row" fxLayoutAlign="start center" class="push-top-none pull-buttom-sm">
                                        <div class="push-right" *ngIf="property.userEditable">
                                            <mat-label class="mat-hint" style="font-size: 12px;">Render as</mat-label>
                                            <mat-select [(ngModel)]="property.renderType"
                                                        name="renderType"
                                                        (change)="onRenderTypeChange(property)"
                                                        placeholder="Render Input As..."
                                                        [ngModelOptions]="{standalone: true}">
                                                <mat-option *ngFor="let renderType of property.renderTypes" value="{{renderType.type}}">
                                                    {{renderType.label}}
                                                </mat-option>
                                            </mat-select>
                                        </div>

                                        <div style="padding-left:10px;"  matTooltip="Enter each value followed by (enter)">

                                            <td-chips [chipAddition]="true"
                                                    [chipRemoval]="true"
                                                    [items]="property.selectOptions"
                                                    [(ngModel)]="property.selectOptions"
                                                    placeholder="Options"
                                                    [disabled]="disabled"
                                                    [inputPosition]="before ? 'before' : 'after'"
                                                    (inputChange)="filterStrings($event)"
                                                    (add)="customSelectOptionChanged(row)"
                                                    (remove)="customSelectOptionChanged(row)"
                                                    *ngIf="property.userEditable  && property.propertyDescriptor.identifiesControllerService == null && property.renderOptions['selectCustom'] == 'true'">
                                            </td-chips>
                                        </div>

                                        <mat-form-field style="height:30px;margin-bottom:5px; padding-left:10px;"
                                            class="md-block" *ngIf="property.userEditable && property.renderType == 'checkbox-custom'">
                                            <mat-label>{{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.TRUE_VALUE' | translate}}</mat-label>
                                            <input matInput
                                                name="property"
                                                placeholder="true"
                                                type="text"
                                                [(ngModel)]="property.renderOptions['trueValue']"
                                                size="20"
                                                [ngModelOptions]="{standalone: true}"/>
                                        </mat-form-field>

                                        <mat-form-field class="push-right" *ngIf="property.userEditable && property.renderType == 'checkbox-custom'">
                                            <mat-label>{{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.FALSE_VALUE' | translate}}</mat-label>
                                            <input matInput
                                                name="property"
                                                placeholder="false"
                                                type="text"
                                                [(ngModel)]="property.renderOptions['falseValue']"
                                                [ngModelOptions]="{standalone: true}"
                                                size="20"/>
                                        </mat-form-field>

                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>
                    <mat-divider style="position: relative;"></mat-divider>
            </div>

            </ng-container>

        </mat-card-content>
        <div style="display: flex; justify-content: flex-end; position: absolute; background-color: white; width: 100%; padding: 10px;">
            <button mat-button matStepperPrevious style="margin-right:10px;">{{'views.step-buttons.Previous-btn' | translate}}</button>
            <button mat-button matStepperNext [disabled]="!formGroup.valid" style="background-color: rgb(97,109,115); color: rgba(255,255,255,0.87);">{{'views.step-buttons.Continue-btn' | translate}} {{stepIndex + 2}}</button>
        </div>
    </mat-card>

    <mat-card offsetleftfromprevious top="8" card-css="layout-fill"
                 id="property-legend-{{processorPropertiesFieldName}}"
               style="max-width:250px;width:250px;min-width:250px;" flex="initial">
        <mat-card-title style="margin-bottom:0">
            <div class="card-title">{{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.FILTER' | translate}}</div>
            <mat-hint style="font-size: 12px;" [translate]="'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.SHOWING_PROPS'" [translateParams]="{number:allProperties.length}"></mat-hint>
        </mat-card-title>

        <mat-card-content style="padding:0">
            <mat-checkbox name="selectedItems" [(ngModel)]="showOnlySelected" aria-label="Show Selected" (change)="onShowOnlySelected()" style="padding-left: 25px;">
                {{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.SHOW_ONLY_SELECTED' | translate}}
            </mat-checkbox>
            <div style="padding: 16px; margin-top: 16px;" class="md-primary left-aligned md-subheader md-kylo-theme layout-padding-left">{{'FEEDMGR.TEMPLATES.STEPPER.PROCESSOR_PROPS.JUMP_TO_GROUP' | translate}}</div>

            <div md-auto-shrink="true" md-auto-shrink-min="5" style="height:300px; overflow: auto;"
                                   layout-align="start start" layout="column" md-item-size="30">

                <ng-container *ngFor="let processor of processors; let last=last" >
                    <button (click)="scrollToProcessor(processor)" class="grey md-button md-kylo-theme" style="text-transform: capitalize;text-align:left" >
                        {{processor.name}}
                    </button>
                    <mat-divider style="position: relative" *ngIf="!last"></mat-divider>
                </ng-container>
            </div>

        </mat-card-content>

    </mat-card>
</div>
