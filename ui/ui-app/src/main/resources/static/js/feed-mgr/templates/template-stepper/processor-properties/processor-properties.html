<!--
  #%L
  thinkbig-ui-feed-manager
  %%
  Copyright (C) 2017 ThinkBig Analytics
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
  <div layout="row" class="centered">

    <mat-card class="not-centered" card-css="layout-fill" style="max-width:980px;width:980px;overflow-x:inherit" flex="initial">

        <mat-card-title>
            <div layout="row" layout-align="space-between-center" flex>
                <div flex class="card-title">{{cardTitle}}</div>
                <div class="card-sub-header">{{stepNumber}} of 5</div>
            </div>
        </mat-card-title>

        <mat-card-content>

            <!-- <ng-form name="vm.propertiesForm" layout-fill>
                    <md-virtual-repeat-container browser-height browser-height-offset="300"
                                                 browser-height-scroll-y="false" style="width:100%;"
                                                 md-top-index="vm.topIndex">
                        <ng-template let-row="row" let-last="last" let-index="index" tdVirtualScrollRow> -->

            <ng-container [formGroup]="formGroup" layout-fill>
                    <!-- <td-virtual-scroll-container #virtualScroll [style.height.px]="300" [data]="allProperties">

                        <ng-template let-row="row" let-last="last" let-index="index" tdVirtualScrollRow> -->
                                             
                    <md-virtual-repeat-container browser-height browser-height-offset="300"
                                                    browser-height-scroll-y="false" style="width:100%;"
                                                    md-top-index="topIndex">

                        <div *ngFor="let property of allProperties " layout="column" layout-fill>

                            <div *ngIf="property.firstProperty" layout="row" class="layout-padding-left-16 layout-padding-top-bottom" style="background-color:#F9F9F9;">
                                <a id="{{property.processor.id}}" name="{{property.processor.name}}"></a>
                                <span class="primary-color-1 md-subhead left-aligned">{{property.processor.name}}</span>
                            </div>
                            <div layout="row" style="padding-left:30px;">
                                <div style="height:30px;margin-bottom:5px;padding-top: 16px;" class="md-block">
                                    <div class="mat-checkbox-div-top" *ngFor="let v of [0]">
                                        <mat-checkbox name="selectedProperty" aria-label="Select" [ngModelOptions]="{standalone: true}" [(ngModel)]="property.selected"></mat-checkbox>
                                    </div>
                                </div>
                                <div class="register-template-property md-padding" layout="column" layout-fill>
                                    <h3 [ngClass]="{'md-warn':property.sensitive}">{{property.key}}</h3>
                                    
                                    <mat-hint *ngIf="property.propertyDescriptor.sensitive">This is a NiFi sensitive property</mat-hint>
                                    <mat-hint *ngIf="property.propertyDescriptor.required">
                                        This is a NiFi required field. You need to either allow the user to input data, or supply a default value.
                                    </mat-hint>
                                    <mat-hint>
                                        {{property.propertyDescriptor.description}}
                                    </mat-hint>

                                    <div *ngIf="property.selected == true" style="padding-top:10px;" class="fade">
                                        <form name="innerForm">

                                            <div *ngIf="property.propertyDescriptor.allowableValues != null">
                                                <mat-form-field md-no-float class="md-block">
                                                    <mat-label>Default Value</mat-label>
                                                    <mat-select [(ngModel)]="property.value" name="property"
                                                               placeholder="Default Value">
                                                        <!--  | orderBy:'value' track by allowableValue.value-->
                                                        <mat-option *ngFor="let allowableValue of property.propertyDescriptor.allowableValues"
                                                                value="{{allowableValue.value}}">
                                                            {{allowableValue.displayName }}
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>
                                            </div>


                                            <div *ngIf="property.propertyDescriptor.allowableValues == null && property.selected == true">

                                                <mat-form-field style="height:30px;margin-bottom:5px;" class="md-block">
                                                    <mat-label>Default Value (Supports Expressions)</mat-label>
                                                    <input *ngIf="!property.userEditable && property.propertyDescriptor.required"
                                                           matInput 
                                                           name="propertyInput"
                                                           placeholder="Enter a string or ${expression})" mentio
                                                           type="text"
                                                           mentio-id="property.mentioId"
                                                           mentio-typed-text="typedTerm"
                                                           [(ngModel)]="property.value"
                                                           size="100"
                                                           formControlName="{{property.key}}"
                                                           (change)="changedPropertyInput(property)"
                                                           (keydown)="keydownPropertyInput(property)"
                                                            ng-init="property.changed=false"
                                                            required/>

                                                        <input *ngIf="property.userEditable || !property.propertyDescriptor.required"
                                                           matInput 
                                                           name="propertyInput"
                                                           placeholder="Enter a string or ${expression})" mentio
                                                           type="text"
                                                           mentio-id="property.mentioId"
                                                           mentio-typed-text="typedTerm"
                                                           [(ngModel)]="property.value"
                                                           size="100"
                                                           (change)="changedPropertyInput(property)"
                                                           (keydown)="keydownPropertyInput(property)"
                                                            ng-init="property.changed=false"/>
                                                </mat-form-field>

                                                <mentio-menu style="display:none;"
                                                             mentio-for="property.mentioId"
                                                             mentio-trigger-char="'$'"
                                                             mentio-items="expressionProperties"
                                                             mentio-template-url="js/feed-mgr/templates/template-stepper/processor-properties/expression-property-mentions.html"
                                                             mentio-search="searchExpressionProperties(term)"
                                                             mentio-select="getExpressionPropertyTextRaw(item)"></mentio-menu>

                                                <div class="hint" thinkbig-derived-expression [model]="property.value"
                                                     style="margin-bottom:10px;"></div>

                                            </div>

                                            <div layout="row" layout-align="start-center">

                                                <div style="height:30px;margin-bottom:5px;"
                                                                    class="md-block" *ngIf="property.value == null || property.value == ''">
                                                    <div class="mat-checkbox-div-top" *ngFor="let v of [0]">
                                                        <mat-checkbox aria-label="Set as empty string"
                                                                     [checked]="property.value == ''"
                                                                     (click)="toggleSetAsEmptyString(property)">
                                                            Set as empty string
                                                        </mat-checkbox>
                                                    </div>
                                                </div>
                                                <div style="height:30px;margin-bottom:5px;padding-left:10px;"
                                                                    class="md-block">
                                                    <div class="mat-checkbox-div-top" *ngFor="let v of [0]">
                                                        <mat-checkbox aria-label="User can supply input"
                                                                     [(ngModel)]="property.userEditable"
                                                                     name="userEditable">
                                                          Allow user input
                                                        </mat-checkbox>
                                                    </div>
                                                </div>
                                                <mat-form-field style="height:30px;margin-bottom:5px; padding-left:10px;"
                                                        class="md-block" *ngIf="property.userEditable">
                                                    <mat-label>Render as</mat-label>
                                                    <mat-select [(ngModel)]="property.renderType" 
                                                                name="renderType" 
                                                                (change)="onRenderTypeChange(property)"
                                                                placeholder="Render Input As...">
                                                        <!--  | orderBy:'label' track by renderType.type-->
                                                        <mat-option
                                                                *ngFor="let renderType of property.renderTypes"
                                                                value="{{renderType.type}}">
                                                            {{renderType.label}}
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>

                                                <mat-form-field
                                                  style="height:30px;margin-bottom:5px; padding-left:10px;"
                                                  class="md-block" *ngIf="property.userEditable && property.renderType == 'checkbox-custom'">
                                                <mat-label>True Value</mat-label>
                                                <input matIput
                                                       name="property"
                                                       placeholder="true"
                                                       type="text"
                                                       [(ngModel)]="property.renderOptions['trueValue']" size="20"/>
                                                </mat-form-field>

                                              <mat-form-field
                                                  style="height:30px;margin-bottom:5px; padding-left:10px;"
                                                  class="md-block" *ngIf="property.userEditable && property.renderType == 'checkbox-custom'">
                                                <mat-label>False Value</mat-label>
                                                <input matInput
                                                       name="property"
                                                       placeholder="false"
                                                       type="text"
                                                       [(ngModel)]="property.renderOptions['falseValue']" size="20"/>
                                              </mat-form-field>

                                              <div style="padding-left:10px;">

                                                <td-chips [chipAddition]="true"
                                                        [chipRemoval]="true"
                                                        [items]="property.selectOptions"
                                                        [(ngModel)]="property.selectOptions"
                                                        placeholder="Add Select Options"
                                                        [disabled]="disabled"
                                                        [inputPosition]="before ? 'before' : 'after'"
                                                        (inputChange)="filterStrings($event)"
                                                        (add)="customSelectOptionChanged(row)"
                                                        (remove)="customSelectOptionChanged(row)"
                                                        *ngIf="property.userEditable  && property.propertyDescriptor.identifiesControllerService == null && property.renderOptions['selectCustom'] == 'true'">
                                                </td-chips>

                                              </div>
                                                <div>
                                                    <div style="height:30px;margin-bottom:5px;"
                                                                        class="md-block">
                                                        <div class="mat-checkbox-div-top" *ngFor="let v of [0]">
                                                            <mat-checkbox aria-label="Sensitive"
                                                                         name = "sensitiveProperty"
                                                                         [(ngModel)]="property.sensitive"
                                                                         [disabled]="property.propertyDescriptor.sensitive">
                                                                Sensitive
                                                            </mat-checkbox>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div *ngIf="property.userEditable">
                                                    <div style="height:30px;margin-bottom:5px;"
                                                                        class="md-block">
                                                        <div class="mat-checkbox-div-top" *ngFor="let v of [0]">
                                                            <mat-checkbox aria-label="Required"
                                                                         name="requiredProperty"
                                                                         [(ngModel)]="property.required"
                                                                         [disabled]="property.propertyDescriptor.required">
                                                                Required
                                                            </mat-checkbox>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </form>

                                    </div>


                                </div>

                            </div>
                            <mat-divider *ngIf="!last"></mat-divider>
                        </div>


                    </md-virtual-repeat-container>


                    <!-- <thinkbig-step-buttons can-continue="isValid && propertiesForm.$valid"
                                           step-index="{{stepIndex}}"></thinkbig-step-buttons> -->
            </ng-container>

        </mat-card-content>

    </mat-card>

    <mat-card offsetleftfromprevious top="8" card-css="layout-fill"
                 id="property-legend-{{processorPropertiesFieldName}}"
                 style="max-width:250px;width:250px;min-width:250px;" flex="initial">
        <mat-card-title>
            <div class="card-title">Filter</div>
            <mat-hint>Showing {{allProperties.length}} properties</mat-hint>
        </mat-card-title>

        <mat-card-content style="padding-left:25px;">
            <mat-checkbox name="selectedItems" [(ngModel)]="showOnlySelected" aria-label="Show Selected" (change)="onShowOnlySelected()" style="margin-left:-9px">
                Show only selected
            </mat-checkbox>
            <div class="md-primary left-aligned md-subheader md-kylo-theme layout-padding-left">Jump to a group</div>

            <div md-auto-shrink="true" md-auto-shrink-min="5" style="height:300px;"
                     layout-align="start start" layout="column" md-item-size="30">

                <ng-template *ngFor="let processor of processors; let last=last" >
                    <button (click)="scrollToProcessor(processor)" class="grey" style="text-transform: capitalize;text-align:left" >
                        {{processor.name}}
                    </button>
                    <mat-divider *ngIf="!last"></mat-divider>
                </ng-template>
            </div>

        </mat-card-content>

    </mat-card>
</div>
